\doxysection{Orderbook.\+cpp}
\hypertarget{_orderbook_8cpp_source}{}\label{_orderbook_8cpp_source}\index{OrderbookSim/Orderbook.cpp@{OrderbookSim/Orderbook.cpp}}
\mbox{\hyperlink{_orderbook_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_orderbook_8hpp}{Orderbook.hpp}}"{}}}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <mutex>}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00024\ \textcolor{keywordtype}{bool}\ Orderbook::canMatch(\mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00}{Side}}\ side,\ \mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ price)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00025\ \ \ \ \ \textcolor{keywordflow}{if}\ (side\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a831a28f1e8df07c553fcd59546465d13}{Side::Buy}})\ \{}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_asks.empty())\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [bestAsk,\ \_]\ =\ *\_asks.begin();\ \textcolor{comment}{//\ gets\ the\ price}}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ price\ >=\ bestAsk;}
\DoxyCodeLine{00029\ \ \ \ \ \}\ \textcolor{comment}{//\ else\ not\ needed}}
\DoxyCodeLine{00030\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bids.empty())\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00031\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [bestBid,\ \_]\ =\ *\_bids.begin();\ \textcolor{comment}{//\ gets\ the\ price}}
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{keywordflow}{return}\ price\ <=\ bestBid;}
\DoxyCodeLine{00033\ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00043\ \mbox{\hyperlink{_trade_8hpp_a2ac952e5c0e734c3b7ab2068eb3d6527}{Trades}}\ Orderbook::MatchOrders()}
\DoxyCodeLine{00044\ \{}
\DoxyCodeLine{00045\ \ \ \ \ \mbox{\hyperlink{_trade_8hpp_a2ac952e5c0e734c3b7ab2068eb3d6527}{Trades}}\ trades;}
\DoxyCodeLine{00046\ \ \ \ \ trades.reserve(\_orders.size());}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \ \ \textcolor{keywordflow}{while}\ (\textcolor{keyword}{true})}
\DoxyCodeLine{00049\ \ \ \ \ \{}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bids.empty()\ ||\ \_asks.empty())}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ [bidPrice,\ bids]\ =\ *\_bids.begin();}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ [askPrice,\ asks]\ =\ *\_asks.begin();}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (bidPrice\ >\ askPrice)\ \textcolor{comment}{//\ for\ some\ reasoon\ this\ works:\ bidPrice\ >\ askPrice\ should\ be\ the\ other\ way\ around}}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (!bids.empty()\ \&\&\ !asks.empty())}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_order_8hpp_abd4d2b4dd984ef7a42731f33c665be3e}{OrderPtr}}\ bid\ =\ bids.front();}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_order_8hpp_abd4d2b4dd984ef7a42731f33c665be3e}{OrderPtr}}\ ask\ =\ asks.front();}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}}\ quantity\ =\ std::min(bid-\/>getRemainingQty(),\ ask-\/>getRemainingQty());}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ \ \ \ bid-\/>Fill(quantity);}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \ \ ask-\/>Fill(quantity);}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (bid-\/>isFilled())}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ bids.pop\_front();}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_orders.erase(bid-\/>getOrderId());}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ask-\/>isFilled())}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ asks.pop\_front();}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_orders.erase(ask-\/>getOrderId());}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ trades.push\_back(\mbox{\hyperlink{class_trade}{Trade}}\{}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_trade_info}{TradeInfo}}\{\ bid-\/>getOrderId(),\ bid-\/>getPrice(),\ quantity\ \},}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_trade_info}{TradeInfo}}\{\ ask-\/>getOrderId(),\ ask-\/>getPrice(),\ quantity\ \}}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ purchasedPrice\ =\ 0;}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (\_executionType)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ ExecutionTypes::BuyersPrice:}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ purchasedPrice\ =\ std::max(ask-\/>getPrice(),\ bid-\/>getPrice());}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ ExecutionTypes::SellersPrice:}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ purchasedPrice\ =\ std::min(ask-\/>getPrice(),\ bid-\/>getPrice());}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ ExecutionTypes::MidPrice:}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ purchasedPrice\ =\ (ask-\/>getPrice()\ +\ bid-\/>getPrice())\ /\ 2;}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a022cf43ca89b41961555b35b38f55111}{removeMatchedOrder}}(bid-\/>getOrderId(),\ ask-\/>getOrderId());}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ onOrderMatched(bid-\/>getPrice(),\ quantity,\ bid-\/>isFilled());}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ onOrderMatchedWithHistoryUpdate(ask-\/>getPrice(),\ quantity,\ ask-\/>isFilled(),\ purchasedPrice);\ \textcolor{comment}{//\ we\ are\ purchasing\ at\ the\ max\ price}}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (bids.empty())}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \_bids.erase(bidPrice);}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \_data.erase(bidPrice);}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (asks.empty())}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \_asks.erase(askPrice);}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \_data.erase(askPrice);}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00118\ \ \ \ \ \}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_bids.empty())}
\DoxyCodeLine{00121\ \ \ \ \ \{}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ [\_,\ bids]\ =\ *\_bids.begin();}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ order\ =\ bids.front();}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getOrderType()\ ==\ \mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418aecbd0e0c1a29b254d42a648d45b65fb9}{OrderType::FillAndKill}})}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{class_orderbook_a3931170d2aebc21100ca99ee83823d96}{CancelOrder}}(order-\/>getOrderId());}
\DoxyCodeLine{00126\ \ \ \ \ \}}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_asks.empty())}
\DoxyCodeLine{00129\ \ \ \ \ \{}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ [\_,\ asks]\ =\ *\_asks.begin();}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ order\ =\ asks.front();}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getOrderType()\ ==\ \mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418aecbd0e0c1a29b254d42a648d45b65fb9}{OrderType::FillAndKill}})}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{class_orderbook_a3931170d2aebc21100ca99ee83823d96}{CancelOrder}}(order-\/>getOrderId());}
\DoxyCodeLine{00134\ \ \ \ \ \}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keywordflow}{return}\ trades;}
\DoxyCodeLine{00137\ \}}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00146\ \textcolor{keywordtype}{void}\ Orderbook::CancelOrders(\mbox{\hyperlink{_usings_8hpp_a486ef20e0a73d508bd0cce5f8217810b}{OrderIds}}\ orderIds)\ \{}
\DoxyCodeLine{00147\ \ \ \ \ std::scoped\_lock\ ordersLock\{\ \_ordersMutex\ \};}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ orderId\ :\ orderIds)\ CancelOrderInternal(orderId);}
\DoxyCodeLine{00149\ \}}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00158\ \textcolor{keywordtype}{void}\ Orderbook::CancelOrderInternal(\mbox{\hyperlink{_usings_8hpp_a90716e500cb73455f03ac5b21fc7c219}{OrderId}}\ orderId)\ \{}
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_orders.contains(orderId))\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ [order,\ orderIter]\ =\ \_orders.at(orderId);\ \textcolor{comment}{//\ types\ returned\ OrderId,\ OrderEntry}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getSide()\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a3068c5a98c003498f1fec0c489212e8b}{Side::Sell}})\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ price\ =\ order-\/>getPrice();}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ orders\ =\ \_asks.at(price);}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ orders.erase(orderIter);}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (orders.empty())\ \_asks.erase(price);}
\DoxyCodeLine{00167\ \ \ \ \ \}}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{comment}{//if(order-\/>getSide()\ ==\ Side::Buy)\ }}
\DoxyCodeLine{00169\ \ \ \ \ \{}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ price\ =\ order-\/>getPrice();}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ orders\ =\ \_bids.at(price);}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ orders.erase(orderIter);}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (orders.empty())\ \_bids.erase(price);}
\DoxyCodeLine{00174\ \ \ \ \ \}}
\DoxyCodeLine{00175\ \ \ \ \ onOrderCanceleld(order);}
\DoxyCodeLine{00176\ \ \ \ \ \_orders.erase(orderId);\ \textcolor{comment}{//\ delete\ the\ order\ from\ orders\ by\ Id\ at\ the\ end}}
\DoxyCodeLine{00177\ \}}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00189\ \textcolor{keywordtype}{bool}\ Orderbook::canFullyFill(\mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00}{Side}}\ side,\ \mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ price,\ \mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}}\ quantity)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{keywordflow}{if}\ (!canMatch(side,\ price))\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00192\ \ \ \ \ std::optional<Price>\ threshold;}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keywordflow}{if}\ (side\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a831a28f1e8df07c553fcd59546465d13}{Side::Buy}})\ \{}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [askPrice,\ \_]\ =\ *\_asks.begin();}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ threshold\ =\ askPrice;}
\DoxyCodeLine{00197\ \ \ \ \ \}}
\DoxyCodeLine{00198\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [bidPrice,\ \_]\ =\ *\_bids.begin();}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ threshold\ =\ bidPrice;}
\DoxyCodeLine{00201\ \ \ \ \ \}}
\DoxyCodeLine{00202\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [levelPrice,\ levelData]\ :\ \_data)\ \{}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (threshold.has\_value()\ \&\&}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ (side\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a831a28f1e8df07c553fcd59546465d13}{Side::Buy}}\ \&\&\ threshold.value()\ >\ levelPrice)\ ||}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ (side\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a3068c5a98c003498f1fec0c489212e8b}{Side::Sell}}\ \&\&\ threshold.value()\ <\ levelPrice)}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \ \ )\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((side\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a831a28f1e8df07c553fcd59546465d13}{Side::Buy}}\ \&\&\ levelPrice\ >\ price)\ ||}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ \ \ \ (side\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a3068c5a98c003498f1fec0c489212e8b}{Side::Sell}}\ \&\&\ levelPrice\ <\ price))\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (quantity\ <=\ levelData.\_quantity)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ quantity\ -\/=\ levelData.\_quantity;}
\DoxyCodeLine{00211\ \ \ \ \ \}}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00213\ \}}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00222\ \textcolor{keywordtype}{void}\ Orderbook::onOrderCanceleld(\mbox{\hyperlink{_order_8hpp_abd4d2b4dd984ef7a42731f33c665be3e}{OrderPtr}}\ order)\ \{}
\DoxyCodeLine{00223\ \ \ \ \ UpdateLevelData(order-\/>getPrice(),\ order-\/>getRemainingQty(),\ LevelData::Action::Remove);}
\DoxyCodeLine{00224\ \}}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00233\ \textcolor{keywordtype}{void}\ Orderbook::onOrderAdded(\mbox{\hyperlink{_order_8hpp_abd4d2b4dd984ef7a42731f33c665be3e}{OrderPtr}}\ order)\ \{}
\DoxyCodeLine{00234\ \ \ \ \ UpdateLevelData(order-\/>getPrice(),\ order-\/>getInitialQty(),\ LevelData::Action::Add);}
\DoxyCodeLine{00235\ \}}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00247\ \textcolor{keywordtype}{void}\ Orderbook::onOrderMatchedWithHistoryUpdate(\mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ price,\ \mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}}\ quantity,\ \textcolor{keywordtype}{bool}\ isFullyFilled,\ \mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ purchasePrice)\ \{}
\DoxyCodeLine{00248\ \ \ \ \ \textcolor{keywordflow}{if}\ (purchasePrice\ ==\ 0)\ \{\textcolor{comment}{/*DO\ NOTHING*/};\ \}}
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (isFullyFilled)\ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a0209579741cc6ff09b61e37a4d2bda5e}{addOrderToPurchaseHistory}}(purchasePrice,\ quantity);}
\DoxyCodeLine{00250\ \ \ \ \ \textcolor{keywordflow}{else}\ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a0209579741cc6ff09b61e37a4d2bda5e}{addOrderToPurchaseHistory}}(purchasePrice,\ std::min(quantity,\ \_data[price].\_quantity));}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00252\ \ \ \ \ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_addcc5e1737508a1974689610d20d4c27}{updateNeutralNetwork}}(purchasePrice,\ std::min(quantity,\ \_data[price].\_quantity));}
\DoxyCodeLine{00253\ }
\DoxyCodeLine{00254\ \ \ \ \ UpdateLevelData(price,\ quantity,\ isFullyFilled\ ?\ LevelData::Action::Remove\ :\ LevelData::Action::Match);}
\DoxyCodeLine{00255\ \}}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00266\ \textcolor{keywordtype}{void}\ Orderbook::onOrderMatched(\mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ price,\ \mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}}\ quantity,\ \textcolor{keywordtype}{bool}\ isFullyFilled)\ \{}
\DoxyCodeLine{00267\ \ \ \ \ UpdateLevelData(price,\ quantity,\ isFullyFilled\ ?\ LevelData::Action::Remove\ :\ LevelData::Action::Match);}
\DoxyCodeLine{00268\ \}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00279\ \textcolor{keywordtype}{void}\ Orderbook::UpdateLevelData(\mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ price,\ \mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}}\ quantity,\ LevelData::Action\ action)\ \{}
\DoxyCodeLine{00280\ \ \ \ \ \textcolor{keyword}{auto}\&\ data\ =\ \_data[price];}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \ \ \ \ data.\_count\ +=\ action\ ==\ LevelData::Action::Remove\ ?\ -\/1\ :\ action\ ==\ LevelData::Action::Add\ ?\ 1\ :\ 0;}
\DoxyCodeLine{00283\ \ \ \ \ \textcolor{keywordflow}{if}\ (action\ ==\ LevelData::Action::Remove\ ||\ action\ ==\ LevelData::Action::Match)}
\DoxyCodeLine{00284\ \ \ \ \ \{}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ data.\_quantity\ -\/=\ quantity;}
\DoxyCodeLine{00286\ \ \ \ \ \}}
\DoxyCodeLine{00287\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00288\ \ \ \ \ \{}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ data.\_quantity\ +=\ quantity;}
\DoxyCodeLine{00290\ \ \ \ \ \}}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ \ \ \ \ \textcolor{keywordflow}{if}\ (data.\_count\ ==\ 0)}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \_data.erase(price);}
\DoxyCodeLine{00294\ \}}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00304\ \mbox{\hyperlink{_trade_8hpp_a2ac952e5c0e734c3b7ab2068eb3d6527}{Trades}}\ Orderbook::MatchOrder(\mbox{\hyperlink{class_order_modify}{OrderModify}}\ order)\ \{}
\DoxyCodeLine{00305\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_orders.contains(order.\mbox{\hyperlink{class_order_modify_a692c19566738eaf577ec4f667370959e}{getOrderId}}()))\ \textcolor{keywordflow}{return}\ \{\ \};}
\DoxyCodeLine{00306\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [existingOrder,\ \_]\ =\ \_orders.at(order.\mbox{\hyperlink{class_order_modify_a692c19566738eaf577ec4f667370959e}{getOrderId}}());}
\DoxyCodeLine{00307\ \ \ \ \ \mbox{\hyperlink{class_orderbook_a3931170d2aebc21100ca99ee83823d96}{CancelOrder}}(order.\mbox{\hyperlink{class_order_modify_a692c19566738eaf577ec4f667370959e}{getOrderId}}());}
\DoxyCodeLine{00308\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{namespaceadd_order}{addOrder}}(order.\mbox{\hyperlink{class_order_modify_a5437e58124c8d3c858aa4501b673b456}{toOrderPtr}}(existingOrder-\/>getOrderType()));}
\DoxyCodeLine{00309\ \}}
\DoxyCodeLine{00310\ }
\DoxyCodeLine{00316\ \textcolor{keywordtype}{void}\ Orderbook::PruneGoodForDayOrders()\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{keyword}{using\ namespace\ }std::chrono;}
\DoxyCodeLine{00318\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ end\ =\ hours(16);}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{keywordflow}{while}\ (\textcolor{keyword}{true})\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ now\ =\ system\_clock::now();}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ now\_c\ =\ system\_clock::to\_time\_t(now);}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ std::tm\ now\_parts;}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ localtime\_s(\&now\_parts,\ \&now\_c);}
\DoxyCodeLine{00324\ }
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (now\_parts.tm\_hour\ >=\ end.count())\ now\_parts.tm\_mday++;}
\DoxyCodeLine{00326\ }
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ now\_parts.tm\_hour\ =\ end.count();}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ now\_parts.tm\_min\ =\ 0;}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ now\_parts.tm\_sec\ =\ 0;}
\DoxyCodeLine{00330\ }
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ next\ =\ system\_clock::from\_time\_t(mktime(\&now\_parts));}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ till\ =\ next\ -\/\ now\ +\ milliseconds(100);}
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \{\ \textcolor{comment}{//\ we\ don't\ want\ this\ thread\ to\ alter\ the\ state\ of\ our\ data\ structures\ at\ the\ same\ time}}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \ \ \ \ std::unique\_lock\ ordersLock\{\ \_ordersMutex\ \};}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_shutdown.load(std::memory\_order\_acquire)}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ \_shutdownConditionVariable.wait\_for(ordersLock,\ till)\ ==\ std::cv\_status::no\_timeout)}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00340\ }
\DoxyCodeLine{00341\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_usings_8hpp_a486ef20e0a73d508bd0cce5f8217810b}{OrderIds}}\ orderIds;}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \ \ \ \ \ \ std::scoped\_lock\ ordersLock\{\ \_ordersMutex\ \};}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [\_,\ entry]\ :\ \_orders)\ \{}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [order,\ \_]\ =\ entry;}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getOrderType()\ !=\ \mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418aba4a0e6c0bf4a4e1ac97580ed933f063}{OrderType::GoodForDay}})\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ orderIds.push\_back(order-\/>\mbox{\hyperlink{class_order_modify_a692c19566738eaf577ec4f667370959e}{getOrderId}}());}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00351\ }
\DoxyCodeLine{00352\ \ \ \ \ \ \ \ \ CancelOrders(orderIds);}
\DoxyCodeLine{00353\ \ \ \ \ \}}
\DoxyCodeLine{00354\ \}}
\DoxyCodeLine{00355\ }
\DoxyCodeLine{00367\ \mbox{\hyperlink{_trade_8hpp_a2ac952e5c0e734c3b7ab2068eb3d6527}{Trades}}\ \mbox{\hyperlink{class_orderbook_aa8ee3a736e8a72797565fdc645361c77}{Orderbook::addOrder}}(\mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418}{OrderType}}\ type,\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00}{Side}}\ side,\ \mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ price,\ \mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}}\ qty)\ \{}
\DoxyCodeLine{00368\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{namespaceadd_order}{addOrder}}(std::make\_shared<Order>(type,\ \mbox{\hyperlink{class_orderbook_af9aec9503cc33a10d6c5dee925a895fb}{Size}}()\ +\ 1,\ side,\ price,\ qty));}
\DoxyCodeLine{00369\ \}}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00383\ \mbox{\hyperlink{_trade_8hpp_a2ac952e5c0e734c3b7ab2068eb3d6527}{Trades}}\ \mbox{\hyperlink{class_orderbook_aa8ee3a736e8a72797565fdc645361c77}{Orderbook::addOrder}}(\mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418}{OrderType}}\ type,\ \mbox{\hyperlink{_usings_8hpp_a90716e500cb73455f03ac5b21fc7c219}{OrderId}}\ \textcolor{keywordtype}{id},\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00}{Side}}\ side,\ \mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ price,\ \mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}}\ qty)\ \{}
\DoxyCodeLine{00384\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{namespaceadd_order}{addOrder}}(std::make\_shared<Order>(type,\ \textcolor{keywordtype}{id},\ side,\ price,\ qty));}
\DoxyCodeLine{00385\ \}}
\DoxyCodeLine{00386\ }
\DoxyCodeLine{00398\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_orderbook_a01b99124d091e1ceab16c44c15e67513}{Orderbook::addOrderViaPython}}(\textcolor{keywordtype}{int}\ type,\ \textcolor{keywordtype}{int}\ \textcolor{keywordtype}{id},\ \textcolor{keywordtype}{int}\ side,\ \textcolor{keywordtype}{int}\ price,\ \textcolor{keywordtype}{int}\ qty)\ \{}
\DoxyCodeLine{00399\ \ \ \ \ \mbox{\hyperlink{namespaceadd_order}{addOrder}}(std::make\_shared<Order>(\mbox{\hyperlink{_order_type_8hpp_a45b54c9e8c1e53ef77a5d2c89fb4e4c7}{intToOrdertType}}(type),\ \textcolor{keywordtype}{id},\ side\ \%\ 2\ ==\ 1\ ?\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a831a28f1e8df07c553fcd59546465d13}{Side::Buy}}\ :\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a3068c5a98c003498f1fec0c489212e8b}{Side::Sell}}\ ,\ price,\ qty));}
\DoxyCodeLine{00400\ \ \ \ \ \mbox{\hyperlink{class_orderbook_a9702e3466bf51d56b6c05573271f9547}{saveToJson}}();}
\DoxyCodeLine{00401\ \}}
\DoxyCodeLine{00402\ }
\DoxyCodeLine{00412\ \mbox{\hyperlink{_trade_8hpp_a2ac952e5c0e734c3b7ab2068eb3d6527}{Trades}}\ \mbox{\hyperlink{class_orderbook_aa8ee3a736e8a72797565fdc645361c77}{Orderbook::addOrder}}(\mbox{\hyperlink{_order_8hpp_abd4d2b4dd984ef7a42731f33c665be3e}{OrderPtr}}\ order)\ \{}
\DoxyCodeLine{00413\ \ \ \ \ std::scoped\_lock\ ordersLock\{\ \_ordersMutex\ \};}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \ \ \textcolor{comment}{//\ Add\ to\ history}}
\DoxyCodeLine{00416\ \ \ \ \ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a65eb92a2eb981e3e765ee7e98c00f112}{addOrderToHistory}}(order-\/>getOrderType(),\ order-\/>getOrderId(),\ order-\/>getSide(),\ order-\/>getPrice(),\ order-\/>getQty());}
\DoxyCodeLine{00417\ }
\DoxyCodeLine{00418\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_orders.contains(order-\/>getOrderId()))\ \textcolor{keywordflow}{return}\ \{\ \};}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00420\ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getOrderType()\ ==\ \mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418a31840a66a8d6d223e5b0540138768838}{OrderType::Market}})}
\DoxyCodeLine{00421\ \ \ \ \ \{}
\DoxyCodeLine{00422\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getSide()\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a831a28f1e8df07c553fcd59546465d13}{Side::Buy}}\ \&\&\ !\_asks.empty())}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [worstAsk,\ \_]\ =\ *\_asks.rbegin();}
\DoxyCodeLine{00425\ \ \ \ \ \ \ \ \ \ \ \ \ order-\/>toGoodTillCancel(worstAsk);}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (order-\/>getSide()\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a3068c5a98c003498f1fec0c489212e8b}{Side::Sell}}\ \&\&\ !\_bids.empty())}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [worstBid,\ \_]\ =\ *\_bids.rbegin();}
\DoxyCodeLine{00430\ \ \ \ \ \ \ \ \ \ \ \ \ order-\/>toGoodTillCancel(worstBid);}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00433\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\ \};}
\DoxyCodeLine{00434\ \ \ \ \ \}}
\DoxyCodeLine{00435\ }
\DoxyCodeLine{00436\ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getOrderType()\ ==\ \mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418aecbd0e0c1a29b254d42a648d45b65fb9}{OrderType::FillAndKill}}\ \&\&\ !canMatch(order-\/>getSide(),\ order-\/>getPrice()))\ \textcolor{keywordflow}{return}\ \{\ \};}
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getOrderType()\ ==\ \mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418aaca8c369e3b611e1109cc77a7feaf872}{OrderType::FillOrKill}}\ \&\&\ !canFullyFill(order-\/>getSide(),\ order-\/>getPrice(),\ order-\/>getInitialQty()))\ \textcolor{keywordflow}{return}\ \{\ \};}
\DoxyCodeLine{00438\ }
\DoxyCodeLine{00439\ \ \ \ \ OrderPtrs::iterator\ iter;}
\DoxyCodeLine{00440\ \ \ \ \ \textcolor{keywordflow}{if}\ (order-\/>getSide()\ ==\ \mbox{\hyperlink{_side_8hpp_a8c0137d7160ad71b6ed265c53c99ed00a831a28f1e8df07c553fcd59546465d13}{Side::Buy}})\ \{}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ orders\ =\ \_bids[order-\/>getPrice()];}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ orders.push\_back(order);}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ iter\ =\ std::prev(orders.end());}
\DoxyCodeLine{00444\ \ \ \ \ \}}
\DoxyCodeLine{00445\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ orders\ =\ \_asks[order-\/>getPrice()];}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ \ orders.push\_back(order);}
\DoxyCodeLine{00448\ \ \ \ \ \ \ \ \ iter\ =\ std::prev(orders.end());}
\DoxyCodeLine{00449\ \ \ \ \ \}}
\DoxyCodeLine{00450\ \ \ \ \ \_orders.insert(\{\ order-\/>getOrderId(),\ OrderEntry\{order,iter\}\ \});}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \ \ \ \ onOrderAdded(order);}
\DoxyCodeLine{00453\ }
\DoxyCodeLine{00454\ \ \ \ \ \textcolor{keywordflow}{return}\ MatchOrders();}
\DoxyCodeLine{00455\ \}}
\DoxyCodeLine{00456\ }
\DoxyCodeLine{00464\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_orderbook_a3931170d2aebc21100ca99ee83823d96}{Orderbook::CancelOrder}}(\mbox{\hyperlink{_usings_8hpp_a90716e500cb73455f03ac5b21fc7c219}{OrderId}}\ orderId)\ \{}
\DoxyCodeLine{00465\ \ \ \ \ std::scoped\_lock\ ordersLock\{\ \_ordersMutex\ \};}
\DoxyCodeLine{00466\ \ \ \ \ CancelOrderInternal(orderId);}
\DoxyCodeLine{00467\ \}}
\DoxyCodeLine{00468\ }
\DoxyCodeLine{00477\ \mbox{\hyperlink{_trade_8hpp_a2ac952e5c0e734c3b7ab2068eb3d6527}{Trades}}\ \mbox{\hyperlink{class_orderbook_a1acc77c9ffaddc1ca56f02df0a556426}{Orderbook::ModifyOrder}}(\mbox{\hyperlink{class_order_modify}{OrderModify}}\ order)\ \{}
\DoxyCodeLine{00478\ \ \ \ \ \mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418}{OrderType}}\ orderType;}
\DoxyCodeLine{00479\ \ \ \ \ \{}
\DoxyCodeLine{00480\ \ \ \ \ \ \ \ \ std::scoped\_lock\ ordersLock\{\ \_ordersMutex\ \};}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_orders.contains(order.\mbox{\hyperlink{class_order_modify_a692c19566738eaf577ec4f667370959e}{getOrderId}}()))\ \textcolor{keywordflow}{return}\ \{\ \};}
\DoxyCodeLine{00482\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [existingOrder,\ \_]\ =\ \_orders.at(order.\mbox{\hyperlink{class_order_modify_a692c19566738eaf577ec4f667370959e}{getOrderId}}());}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \ \ orderType\ =\ existingOrder-\/>getOrderType();}
\DoxyCodeLine{00484\ \ \ \ \ \}}
\DoxyCodeLine{00485\ \ \ \ \ \mbox{\hyperlink{class_orderbook_a3931170d2aebc21100ca99ee83823d96}{CancelOrder}}(order.\mbox{\hyperlink{class_order_modify_a692c19566738eaf577ec4f667370959e}{getOrderId}}());}
\DoxyCodeLine{00486\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{namespaceadd_order}{addOrder}}(order.\mbox{\hyperlink{class_order_modify_a5437e58124c8d3c858aa4501b673b456}{toOrderPtr}}(orderType));}
\DoxyCodeLine{00487\ \}}
\DoxyCodeLine{00488\ }
\DoxyCodeLine{00494\ std::size\_t\ \mbox{\hyperlink{class_orderbook_af9aec9503cc33a10d6c5dee925a895fb}{Orderbook::Size}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \_orders.size();\ \}}
\DoxyCodeLine{00495\ }
\DoxyCodeLine{00504\ \mbox{\hyperlink{class_orderbook_level_infos}{OrderbookLevelInfos}}\ \mbox{\hyperlink{class_orderbook_a952bf9295a260ff01d0f787713ca65af}{Orderbook::getOrderInfos}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00505\ \ \ \ \ \mbox{\hyperlink{_level_info_8hpp_acc6a50eef88f06795f4029aec7837905}{LevelInfos}}\ bidInfos,\ askInfos;}
\DoxyCodeLine{00506\ \ \ \ \ bidInfos.reserve(\_orders.size());}
\DoxyCodeLine{00507\ \ \ \ \ askInfos.reserve(\_orders.size());}
\DoxyCodeLine{00508\ }
\DoxyCodeLine{00509\ \ \ \ \ \textcolor{keyword}{auto}\ CreateLevelInfos\ =\ [](\mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ price,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{_order_8hpp_aa7f24058c403f699fbc193d03b0b854a}{OrderPtrs}}\&\ orders)}
\DoxyCodeLine{00510\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00511\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{struct_level_info}{LevelInfo}}\{\ price,\ std::accumulate(orders.begin(),\ orders.end(),\ (\mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}})0,}
\DoxyCodeLine{00512\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ [](\mbox{\hyperlink{_usings_8hpp_a90c79bb14ac40b274a4d20dd85f0469d}{Quantity}}\ runningSum,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{_order_8hpp_abd4d2b4dd984ef7a42731f33c665be3e}{OrderPtr}}\&\ order)}
\DoxyCodeLine{00513\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\ return\ runningSum\ +\ order-\/>getRemainingQty();\ \})\ \};}
\DoxyCodeLine{00514\ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00515\ }
\DoxyCodeLine{00516\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [price,\ orders]\ :\ \_bids)}
\DoxyCodeLine{00517\ \ \ \ \ \ \ \ \ bidInfos.push\_back(CreateLevelInfos(price,\ orders));}
\DoxyCodeLine{00518\ }
\DoxyCodeLine{00519\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ [price,\ orders]\ :\ \_asks)}
\DoxyCodeLine{00520\ \ \ \ \ \ \ \ \ askInfos.push\_back(CreateLevelInfos(price,\ orders));}
\DoxyCodeLine{00521\ }
\DoxyCodeLine{00522\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{class_orderbook_level_infos}{OrderbookLevelInfos}}\{\ bidInfos,\ askInfos\ \};}
\DoxyCodeLine{00523\ \}}
\DoxyCodeLine{00524\ }
\DoxyCodeLine{00530\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_orderbook_aee40f7d214986ff6b0779fe12c498594}{Orderbook::printAllOrders}}()\ \{}
\DoxyCodeLine{00531\ \ \ \ \ \textcolor{comment}{//\_orderDetailHistory.\_printSellHistory();}}
\DoxyCodeLine{00532\ \ \ \ \ \textcolor{comment}{//\_orderDetailHistory.\_printBuyHistory();}}
\DoxyCodeLine{00533\ \ \ \ \ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_ae1699409e402747d0249b4cacb69e08b}{\_printPurchaseHistory}}();}
\DoxyCodeLine{00534\ \ \ \ \ \textcolor{comment}{//\_orderDetailHistory.\_printLiveOrders();}}
\DoxyCodeLine{00535\ }
\DoxyCodeLine{00536\ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Purchase\ History\ Size:\ "{}}\ <<\ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_add68962f12a00beadf15c2d3f19f2838}{purchaseHistorySize}}();}
\DoxyCodeLine{00537\ }
\DoxyCodeLine{00538\ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Sell\ History\ Size:\ "{}}\ <<\ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a6bed3ea20f7b2f16e453fcb5dfed9fd1}{sellHistorySize}}();}
\DoxyCodeLine{00539\ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Buy\ History\ Size:\ "{}}\ <<\ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a8c6d46b597381a834d361ee510839c93}{buyHistorySize}}();}
\DoxyCodeLine{00540\ \ \ \ \ }
\DoxyCodeLine{00541\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_ace0afa64e4e248705363c6e35fc9dbbc}{getVWAP}}()\ ==\ 0)\ std::cout\ <<\ \textcolor{stringliteral}{"{}No\ purchases\ made"{}}\ <<\ std::endl;}
\DoxyCodeLine{00542\ \ \ \ \ \textcolor{keywordflow}{else}\ std::cout\ <<\ \textcolor{stringliteral}{"{}The\ VWAP\ of\ this\ item\ is\ "{}}\ <<\ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_ace0afa64e4e248705363c6e35fc9dbbc}{getVWAP}}()\ <<\ std::endl;}
\DoxyCodeLine{00543\ }
\DoxyCodeLine{00544\ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}PREDICTION\ "{}}\ <<\ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a7901c7d902a3e0412328432978781da0}{getPrediction}}()\ <<\ std::endl;}
\DoxyCodeLine{00545\ \}}
\DoxyCodeLine{00546\ }
\DoxyCodeLine{00558\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_orderbook_a9702e3466bf51d56b6c05573271f9547}{Orderbook::saveToJson}}(\textcolor{keyword}{const}\ std::string\&\ buyfilename,\ \textcolor{keyword}{const}\ std::string\&\ sellfilename,\ \textcolor{keyword}{const}\ std::string\&\ purchasefilename,\ \textcolor{keyword}{const}\ std::string\&\ buyLivefilename,\ \textcolor{keyword}{const}\ std::string\&\ sellLivefilename)\ \{}
\DoxyCodeLine{00559\ \ \ \ \ \_orderDetailHistory.saveHistoryToJson(buyfilename,\ sellfilename,\ purchasefilename,\ sellLivefilename,\ buyLivefilename);}
\DoxyCodeLine{00560\ \}}
\DoxyCodeLine{00561\ }
\DoxyCodeLine{00569\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_orderbook_aad91e372cc4e6454c03e4b4a43dad977}{Orderbook::changeExecutionType}}(\textcolor{keywordtype}{int}\ type)\ \{}
\DoxyCodeLine{00570\ \ \ \ \ \textcolor{keywordflow}{switch}\ (type)\ \{}
\DoxyCodeLine{00571\ \ \ \ \ \textcolor{keywordflow}{case}\ 0:\ \_executionType\ =\ ExecutionTypes::BuyersPrice;\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00572\ \ \ \ \ \textcolor{keywordflow}{case}\ 1:\ \_executionType\ =\ ExecutionTypes::SellersPrice;\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00573\ \ \ \ \ \textcolor{keywordflow}{case}\ 2:\ \_executionType\ =\ ExecutionTypes::MidPrice;\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00574\ \ \ \ \ \textcolor{keywordflow}{default}:\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00575\ \ \ \ \ \}}
\DoxyCodeLine{00576\ \}}
\DoxyCodeLine{00577\ }
\DoxyCodeLine{00583\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_orderbook_aa141f3177a4abd843e53fffbf6699f19}{Orderbook::EndOfDay}}()\ \{}
\DoxyCodeLine{00584\ \ \ \ \ std::unordered\_map<OrderId,\ bool>\ goodToCancels;}
\DoxyCodeLine{00585\ }
\DoxyCodeLine{00586\ \ \ \ \ \textcolor{comment}{//\ Handle\ live\ orders}}
\DoxyCodeLine{00587\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ m\ :\ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a2125b507c1f6844d995b2ce67b63f340}{getLiveOrders}}())\ \{}
\DoxyCodeLine{00588\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m.second.OrderType()\ !=\ \mbox{\hyperlink{_order_type_8hpp_a57124e387290311f33f3b54a54930418aba4a0e6c0bf4a4e1ac97580ed933f063}{OrderType::GoodForDay}})\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00589\ \ \ \ \ \ \ \ \ goodToCancels[m.first]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00590\ \ \ \ \ \ \ \ \ \_orderDetailHistory.\mbox{\hyperlink{class_order_detail_history_a850bb8c0917adec18a552e7a093b0be2}{deleteALiveOrder}}(m.first);}
\DoxyCodeLine{00591\ \ \ \ \ \}}
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00593\ \ \ \ \ \textcolor{comment}{//\ Remove\ orders\ not\ in\ goodToCancels}}
\DoxyCodeLine{00594\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ it\ =\ \_orders.begin();\ it\ !=\ \_orders.end();\ )\ \{}
\DoxyCodeLine{00595\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (goodToCancels.find(it-\/>first)\ !=\ goodToCancels.end())\ \{}
\DoxyCodeLine{00596\ \ \ \ \ \ \ \ \ \ \ \ \ ++it;}
\DoxyCodeLine{00597\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00598\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00599\ \ \ \ \ \ \ \ \ \ \ \ \ it\ =\ \_orders.erase(it);}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00601\ \ \ \ \ \}}
\DoxyCodeLine{00602\ }
\DoxyCodeLine{00603\ \ \ \ \ \textcolor{comment}{//\ Clean\ up\ bids}}
\DoxyCodeLine{00604\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ it\ =\ \_bids.begin();\ it\ !=\ \_bids.end();\ )\ \{}
\DoxyCodeLine{00605\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ orderptrs\ =\ it-\/>second;}
\DoxyCodeLine{00606\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ orderIt\ =\ orderptrs.begin();\ orderIt\ !=\ orderptrs.end();\ )\ \{}
\DoxyCodeLine{00607\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (goodToCancels.find((*orderIt)-\/>getOrderId())\ !=\ goodToCancels.end())\ \{}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ orderIt\ =\ orderptrs.erase(orderIt);}
\DoxyCodeLine{00609\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00610\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00611\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++orderIt;}
\DoxyCodeLine{00612\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (orderptrs.empty())\ \{}
\DoxyCodeLine{00615\ \ \ \ \ \ \ \ \ \ \ \ \ it\ =\ \_bids.erase(it);}
\DoxyCodeLine{00616\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00617\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00618\ \ \ \ \ \ \ \ \ \ \ \ \ ++it;}
\DoxyCodeLine{00619\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00620\ \ \ \ \ \}}
\DoxyCodeLine{00621\ }
\DoxyCodeLine{00622\ \ \ \ \ \textcolor{comment}{//\ Clean\ up\ asks}}
\DoxyCodeLine{00623\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ it\ =\ \_asks.begin();\ it\ !=\ \_asks.end();\ )\ \{}
\DoxyCodeLine{00624\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ orderptrs\ =\ it-\/>second;}
\DoxyCodeLine{00625\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ orderIt\ =\ orderptrs.begin();\ orderIt\ !=\ orderptrs.end();\ )\ \{}
\DoxyCodeLine{00626\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (goodToCancels.find((*orderIt)-\/>getOrderId())\ !=\ goodToCancels.end())\ \{}
\DoxyCodeLine{00627\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ orderIt\ =\ orderptrs.erase(orderIt);}
\DoxyCodeLine{00628\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00629\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00630\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++orderIt;}
\DoxyCodeLine{00631\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00632\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (orderptrs.empty())\ \{}
\DoxyCodeLine{00634\ \ \ \ \ \ \ \ \ \ \ \ \ it\ =\ \_asks.erase(it);}
\DoxyCodeLine{00635\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00636\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00637\ \ \ \ \ \ \ \ \ \ \ \ \ ++it;}
\DoxyCodeLine{00638\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00639\ \ \ \ \ \}}
\DoxyCodeLine{00640\ \}}
\DoxyCodeLine{00641\ }
\DoxyCodeLine{00649\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_orderbook_a9c3382623ecc8a532b3a5342e95a75f6}{Orderbook::setPriceScale}}(\mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ \_price)\ \{}
\DoxyCodeLine{00650\ \ \ \ \ \_orderDetailHistory.PRICESCALE\ =\ \_price;}
\DoxyCodeLine{00651\ \}}
\DoxyCodeLine{00652\ }
\DoxyCodeLine{00658\ \mbox{\hyperlink{_usings_8hpp_a375e30b119b87df2956b839a36a8d2d5}{Price}}\ \mbox{\hyperlink{class_orderbook_acb02b65f6d820f076c0da649cd860acc}{Orderbook::getPriceScale}}()\ \{}
\DoxyCodeLine{00659\ \ \ \ \ \textcolor{keywordflow}{return}\ \_orderDetailHistory.PRICESCALE;}
\DoxyCodeLine{00660\ \}}

\end{DoxyCode}
